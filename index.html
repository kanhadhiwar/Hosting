<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Host Pro | Final Auth v7</title>
    <style>
        :root { --accent: #ff4757; --bg: #0b0f1a; --card: #1e293b; --text: #f8fafc; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; }
        .auth-container { width: 100%; max-width: 320px; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #334155; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; outline: none; }
        .auth-btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .login-primary { background: var(--accent); color: white; }
        .signup-secondary { background: #334155; color: white; font-size: 12px; margin-top: 15px; }

        /* Main UI */
        .header { background: #111827; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1e293b; }
        .workspace { flex: 1; display: flex; flex-direction: column; }
        textarea { flex: 1; background: #020617; color: #94a3b8; border: none; padding: 15px; font-family: monospace; outline: none; font-size: 14px; width: 100%; resize: none; }
        #preview-box { flex: 1; background: white; display: none; }
        iframe { width: 100%; height: 100%; border: none; }

        .bottom-nav { background: #111827; padding: 12px; display: flex; gap: 8px; border-top: 1px solid #1e293b; }
        .btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; color: white; font-size: 13px; cursor: pointer; }
        .btn-menu { background: #334155; flex: 0.25; }
        .btn-run { background: #2563eb; }
        .btn-save { background: var(--accent); }

        /* Overlays */
        .history-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b1120; z-index: 9999; display: none; flex-direction: column; }
        .history-header { padding: 15px; border-bottom: 1px solid #1e293b; }
        .search-box { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; margin: 10px 0; outline: none; }
        .history-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        .hist-card { background: var(--card); padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155; }
        .actions { display: flex; gap: 8px; }
        .action-btn { background: rgba(255,255,255,0.05); border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .copy-btn { color: #3b82f6; }
        .del-btn { color: #ff4757; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-container">
        <h2 style="color:var(--accent); text-align:center; margin-bottom:15px;">Host Pro Login</h2>
        <input type="email" id="email" class="auth-input" placeholder="Email Address">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        <button id="btnLogin" class="auth-btn login-primary">LOGIN</button>
        <button id="btnSignup" class="auth-btn signup-secondary">Naya Account Banayein</button>
    </div>
</div>

<div id="main-app" style="display:none; height:100vh; flex-direction:column;">
    <div class="header">
        <div style="font-weight:bold; color:var(--accent);">HOST PRO</div>
        <div style="font-size:11px; color:#94a3b8;">
            <span id="user-email"></span> | <b id="btnLogout" style="color:var(--accent)">Logout</b>
        </div>
    </div>

    <div class="workspace">
        <textarea id="editor" placeholder="Code yahan likhein..."></textarea>
        <div id="preview-box"><iframe id="preview-frame"></iframe></div>
    </div>

    <div class="bottom-nav">
        <button id="btnMenu" class="btn btn-menu">‚ò∞</button>
        <button id="btnToggle" class="btn btn-run">‚ñ∂ PREVIEW</button>
        <button id="btnSave" class="btn btn-save">‚òÅ SAVE</button>
    </div>
</div>

<div class="history-overlay" id="history-box">
    <div class="history-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; color:var(--accent);">MY CLOUD FILES</span>
            <button id="btnCloseHistory" style="background:none; border:none; color:white; font-size:24px;">‚úï</button>
        </div>
        <input type="text" id="searchInput" class="search-box" placeholder="Search project...">
    </div>
    <div id="storage-meter" style="padding:0 15px; font-size:10px; color:#94a3b8;">Used: <span id="used-kb">0</span> KB</div>
    <div class="history-content" id="history-items"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, set, get, remove, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLpw45mgFqQW-ss-uFEvBt0_IZGgY3Gp8",
        authDomain: "hosting-9731c.firebaseapp.com",
        databaseURL: "https://hosting-9731c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "hosting-9731c",
        storageBucket: "hosting-9731c.firebasestorage.app",
        messagingSenderId: "96821178879",
        appId: "1:96821178879:web:d81ff72a0e8cd2256d37ca"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentProjectId = null;
    let isPreview = false;

    // --- Authentication Logic ---
    document.getElementById('btnLogin').onclick = () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
    };

    document.getElementById('btnSignup').onclick = () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        createUserWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
    };

    document.getElementById('btnLogout').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('user-email').innerText = user.email.split('@')[0];
            loadHistory();
        } else {
            currentUser = null;
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
    });

    // --- Copy Helper ---
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            alert("Link Copied! üîó");
        } catch (err) {
            const t = document.createElement("textarea");
            t.value = text; document.body.appendChild(t);
            t.select(); document.execCommand('copy');
            document.body.removeChild(t);
            alert("Link Copied!");
        }
    }

    // --- Save Logic ---
    document.getElementById('btnSave').onclick = async () => {
        const code = document.getElementById('editor').value;
        if(!code) return alert("Kuch likhein!");
        const path = `users/${currentUser.uid}/projects`;

        if(currentProjectId) {
            const snap = await get(ref(db, `${path}/${currentProjectId}`));
            await set(ref(db, `${path}/${currentProjectId}`), {
                name: snap.val().name, html: code, time: new Date().toLocaleString() + " (Updated)"
            });
            alert("Updated!"); return;
        }

        const name = prompt("Project Name:", "My Project");
        if(!name) return;
        const newRef = push(ref(db, path));
        await set(newRef, { name, html: code, time: new Date().toLocaleString() });
        currentProjectId = newRef.key;
        alert("Saved Successfully!");
    };

    // --- History Logic ---
    document.getElementById('btnMenu').onclick = () => {
        document.getElementById('history-box').style.display = 'flex';
        loadHistory();
    };
    document.getElementById('btnCloseHistory').onclick = () => document.getElementById('history-box').style.display = 'none';

    async function loadHistory() {
        const list = document.getElementById("history-items");
        list.innerHTML = "Loading...";
        const snap = await get(query(ref(db, `users/${currentUser.uid}/projects`), limitToLast(50)));
        list.innerHTML = "";
        if(snap.exists()){
            let totalSize = JSON.stringify(snap.val()).length;
            document.getElementById('used-kb').innerText = (totalSize/1024).toFixed(2);
            Object.keys(snap.val()).reverse().forEach(key => {
                const data = snap.val()[key];
                const projectUrl = window.location.origin + window.location.pathname + "?u=" + currentUser.uid + "&id=" + key;
                const card = document.createElement("div");
                card.className = "hist-card";
                card.innerHTML = `
                    <div style="flex:1" onclick="openMe('${key}')">
                        <b>${data.name}</b><br><small>${data.time}</small>
                    </div>
                    <div class="actions">
                        <button class="action-btn copy-btn" id="cp-${key}">üîó</button>
                        <button class="action-btn del-btn" id="dl-${key}">üóë</button>
                    </div>`;
                list.appendChild(card);
                
                document.getElementById(`cp-${key}`).onclick = (e) => { e.stopPropagation(); copyToClipboard(projectUrl); };
                document.getElementById(`dl-${key}`).onclick = (e) => { 
                    e.stopPropagation(); 
                    if(confirm("Delete?")){ remove(ref(db, `users/${currentUser.uid}/projects/${key}`)); loadHistory(); }
                };
            });
        }
    }

    window.openMe = async (key) => {
        const snap = await get(ref(db, `users/${currentUser.uid}/projects/${key}`));
        document.getElementById('editor').value = snap.val().html;
        currentProjectId = key;
        document.getElementById('history-box').style.display = 'none';
    };

    // --- Preview Logic ---
    document.getElementById('btnToggle').onclick = () => {
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview-box');
        isPreview = !isPreview;
        if(isPreview) {
            const doc = document.getElementById('preview-frame').contentWindow.document;
            doc.open(); doc.write(editor.value); doc.close();
            editor.style.display="none"; preview.style.display="block";
            document.getElementById('btnToggle').innerText = "üìù EDIT";
        } else {
            editor.style.display="block"; preview.style.display="none";
            document.getElementById('btnToggle').innerText = "‚ñ∂ PREVIEW";
        }
    };

    // --- Search Logic ---
    document.getElementById('searchInput').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.hist-card').forEach(card => {
            card.style.display = card.querySelector('b').innerText.toLowerCase().includes(term) ? 'flex' : 'none';
        });
    };

    // --- Viewer Logic (Public Link) ---
    window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const viewId = urlParams.get('id');
        const viewUid = urlParams.get('u');
        if(viewId && viewUid){
            document.body.innerHTML = "Loading...";
            const snap = await get(ref(db, `users/${viewUid}/projects/${viewId}`));
            if(snap.exists()){
                document.open(); document.write(snap.val().html); document.close();
            } else { document.body.innerHTML = "Project Not Found"; }
        }
    };
</script>
</body>
</html>
